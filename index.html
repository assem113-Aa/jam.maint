<!doctype html>
<html lang="ar" dir="ltr">
<head>
<meta charset="utf-8">
<title>ELECTRIC.ASSEM - Final (Link Only / No Supabase)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css"/>

<style>
body{margin:0;min-height:100vh;display:grid;place-items:center;font-family:Arial,sans-serif;background:linear-gradient(180deg,#e8f2ff,#f7fbff)}
.card{width:640px;max-width:95%;background:#fff;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.12);overflow:hidden}
.header{text-align:center;padding:20px}
h1{margin:0;color:#123a62}

.image-box{
  margin:15px auto 0;
  border:2px dashed #cfdceb;
  border-radius:14px;
  width:70%;
  max-width:520px;
  min-width:240px;
  height:240px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  position:relative;
  background:#ffffff;
  cursor:default;
}

#image{
  display:none;
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center;
  background:#ffffff;
  touch-action:none;
}

#ph{color:#2b4a66;font-weight:700}

.content{padding:18px}
label{font-size:12px;font-weight:bold;color:#2b4a66}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #cfdceb;margin-top:6px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row-inline{display:flex;gap:10px;align-items:center}
.row-inline input{flex:1}
.row-inline select{width:45%;min-width:160px}

.btns{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:18px}
button{padding:12px;border-radius:14px;border:none;font-weight:bold;cursor:pointer}
.img{background:#eef6ff}
.qr{background:#fff;border:1px solid #cfdceb;color:#0b4c86}
.confirm{background:#0b5ea8;color:#fff}
.func{background:#0b1b2b;color:#fff}

.apply-wrap{margin-top:10px;display:none;justify-content:center;gap:10px}
.apply-btn,.cancel-btn{padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:8px}
.apply-btn{background:#1faa59;color:#fff;border:none}
.cancel-btn{background:#eef6ff;color:#0b4c86;border:1px solid #cfe3fb}

video{width:100%;margin-top:10px;border-radius:12px;display:none}

.tool-btn{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #cfe3fb;
  background:#eef6ff;
  color:#0b4c86;
  font-weight:800;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
}
.tool-btn:active{transform:translateY(1px)}
.tool-btn.on{
  background:#0b5ea8;
  color:#fff;
  border-color:#0b5ea8;
}

.file-input{
  position:absolute;
  left:-9999px;
  width:1px;height:1px;
  opacity:0;
  pointer-events:none;
}

/* QR legacy kept */
#imageBox{position:relative; position:relative;}
#qrInBox{display:none !important;}
#qrFsBtn{display:none !important;}
#qrBadge{display:none !important;}

/* QR side button */
.header-row{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  gap:12px;
  margin-top:15px;
}
.header-row .image-box{ margin:0; }

#qrSideBtn{
  width:64px;
  height:64px;
  border-radius:16px;
  border:2px solid #cfdceb;
  background:#ffffff;
  box-shadow:0 10px 20px rgba(0,0,0,.10);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  position:relative;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
#qrSideBtn:active{ transform: translateY(1px); }
#qrSideBtn svg{ width:30px; height:30px; fill:#0b5ea8; opacity:.95; }
#qrSideBtn .hint{
  position:absolute;
  bottom:-18px;
  left:50%;
  transform:translateX(-50%);
  font-size:11px;
  font-weight:800;
  color:#0b4c86;
  opacity:.8;
  white-space:nowrap;
}
#qrSideBtnImg{
  position:absolute;
  inset:6px;
  border-radius:12px;
  object-fit:cover;
  display:none;
  background:#fff;
}
#qrSideChange{
  position:absolute;
  right:-6px;
  top:-6px;
  width:24px;
  height:24px;
  border-radius:10px;
  border:2px solid #cfdceb;
  background:#0b5ea8;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  box-shadow:0 8px 16px rgba(0,0,0,.14);
}
#qrSideBtn.has-qr::after{
  content:'';
  position:absolute;
  left:10px;
  top:10px;
  width:10px;
  height:10px;
  border-radius:50%;
  background:#1faa59;
  box-shadow:0 6px 12px rgba(0,0,0,.18);
}
#qrSideBtn.has-qr svg{ opacity:1; }
</style>
</head>

<body>
<div class="card">
  <div class="header">
    <h1>ELECTRIC.ASSEM</h1>

    <div class="header-row">
      <div class="image-box" id="imageBox">
        <img id="image" alt="">
        <span id="ph"><i class="fa-solid fa-image"></i> IMAGE PREVIEW</span>

        <div id="qrInBox" title="Open QR fullscreen">
          <img id="qrInBoxImg" alt="QR">
        </div>
        <button id="qrFsBtn" type="button" title="Fullscreen QR">
          <i class="fa-solid fa-up-right-and-down-left-from-center"></i> QR
        </button>
        <div id="qrBadge" title="Download QR as SVG" style="display:none;"></div>
      </div>

      <button id="qrSideBtn" type="button" title="QR (Pick from gallery / Fullscreen)">
        <img id="qrSideBtnImg" alt="QR Preview">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10 0h2v2h-2v-2zm2 2h2v2h-2v-2zm-2 2h2v2h-2v-2zm4-4h2v4h-2v-4zm0 6h2v2h-2v-2zm-4 0h2v2h-2v-2zm-2-4h2v2h-2v-2z"/>
        </svg>
        <div id="qrSideChange" title="Change QR">+</div>
        <div class="hint">QR</div>
      </button>
    </div>

    <div class="apply-wrap" id="applyWrap">
      <button class="apply-btn" id="applyBtn"><i class="fa-solid fa-check"></i> Apply / Save</button>
      <button class="cancel-btn" id="cancelBtn"><i class="fa-solid fa-xmark"></i> Cancel</button>
    </div>

    <div class="tool-wrap" id="toolWrap" style="display:none;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="tool-btn" id="editBtn" type="button"><i class="fa-solid fa-crop-simple"></i> Edit</button>
      <button class="tool-btn" id="fillBtn" type="button" aria-pressed="false"><i class="fa-solid fa-expand"></i> Fill</button>
      <button class="tool-btn" id="resetBtn" type="button"><i class="fa-solid fa-rotate-left"></i> Reset</button>
      <button class="tool-btn" id="downloadBtn" type="button"><i class="fa-solid fa-download"></i> Download</button>

      <div class="zoom-wrap" id="zoomWrap" style="display:none;align-items:center;gap:8px;padding:6px 10px;border:1px solid #cfe3fb;border-radius:12px;background:#fff;">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="zoomRange" type="range" min="0.5" max="3" step="0.01" value="1" style="width:180px;">
        <button class="tool-btn" id="rotLBtn" type="button" title="Rotate Left"><i class="fa-solid fa-rotate-left"></i></button>
        <button class="tool-btn" id="rotRBtn" type="button" title="Rotate Right"><i class="fa-solid fa-rotate-right"></i></button>
      </div>
    </div>

    <div id="qrThumb" style="display:none;position:fixed;right:14px;bottom:14px;width:72px;height:72px;border-radius:14px;border:2px solid #cfdceb;background:#fff;box-shadow:0 12px 24px rgba(0,0,0,.14);overflow:hidden;cursor:pointer;z-index:50;align-items:center;justify-content:center">
      <img id="qrThumbImg" alt="QR" style="width:100%;height:100%;object-fit:contain;display:block">
    </div>

    <div id="qrModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:60;align-items:center;justify-content:center;padding:18px;cursor:pointer">
      <img id="qrModalImg" alt="QR Full" style="width:100vw;height:100vh;object-fit:contain;background:#fff">
    </div>
  </div>

  <div class="content">

    <div class="row" style="margin-top:12px;">
      <div>
        <label>CUSTOMER</label>
        <select id="customer">
          <option value="" selected disabled>Choose...</option>
          <option>KHALDA</option>
          <option>AGIBA</option>
          <option>SCIMITTAR</option>
        </select>
      </div>
      <div>
        <label>RIG</label>
        <input id="rig" placeholder="Rig">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>SYSTEM</label>
        <select id="system">
          <option value="" selected disabled>Choose...</option>
          <option>ATEX</option>
          <option>MTT</option>
          <option>WINCATT</option>
        </select>
      </div>
      <div>
        <label>DEVICE ID</label>
        <input id="deviceId" placeholder="Device ID">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>THREAD TYPE</label>
        <select id="threadType">
          <option value="" selected disabled>Choose...</option>
          <option>VAM TOP</option>
          <option>NEW VAM</option>
          <option>JFE BEAR</option>
          <option>TMK</option>
          <option>TENARIS BLUE</option>
          <option>PH6</option>
          <option>SUPERIOR</option>
          <option>VA EXPLORER</option>
          <option>BTC</option>
        </select>
      </div>
      <div>
        <label>SIZE</label>
        <select id="threadSize">
          <option value="" selected disabled>Choose...</option>
          <option>2 3/8"</option>
          <option>2 7/8"</option>
          <option>3 1/2"</option>
          <option>4 1/2"</option>
          <option>5"</option>
          <option>5 1/5"</option>
          <option>7"</option>
          <option>9 5/8"</option>
        </select>
      </div>
    </div>

    <label style="margin-top:12px;display:block;">JAM TECHNICIANS</label>
    <div class="row" style="margin-top:8px;">
      <div><input id="tech1" placeholder="1- Name"></div>
      <div><input id="tech2" placeholder="2- Name"></div>
    </div>

    <label>LOADCELL S/N</label>
    <div class="row-inline">
      <input id="loadcellNum">
      <select id="loadcellType">
        <option value="" selected disabled>TYPE</option>
        <option value="TENSION">TENSION</option>
        <option value="COMPRESSION">COMPRESSION</option>
      </select>
    </div>

    <label style="margin-top:12px;display:block;">DEVICE STATUS</label>
    <input id="deviceStatus">

    <!-- ✅ فيديو: لينك فقط (Drive) -->
    <label style="margin-top:12px;display:block;">VIDEO LINK (Google Drive)</label>
    <input id="videoLink" placeholder="Paste Drive link here..." inputmode="url" autocomplete="off">

    <div class="btns">
      <button class="img" id="imgBtn"><i class="fa-solid fa-camera"></i> IMAGE</button>
      <button class="qr" id="qrBtn"><i class="fa-solid fa-barcode"></i> QR</button>
      <button class="confirm" id="confirmBtn"><i class="fa-solid fa-circle-check"></i> CONFIRM</button>
      <button class="func" id="vidBtn"><i class="fa-solid fa-video"></i> FUNCTION</button>
    </div>
<img id="qrImg" alt="QR Code" style="width:220px;margin:12px auto 0;display:block;">
    <!-- الفيديو المحلي مقفول (لن نستخدمه) -->
    <video id="video" controls playsinline></video>

    <input type="file" id="imgInput" class="file-input" accept="image/*">
    <input type="file" id="qrInput" class="file-input" accept="image/*,.svg">
    <input type="file" id="vidInput" class="file-input" accept="video/*">
  </div>
</div>

<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>

<script>
const imgBtn = document.getElementById('imgBtn');
const imgInput = document.getElementById('imgInput');
const qrInput = document.getElementById('qrInput');
const imageBox = document.getElementById('imageBox');
const image = document.getElementById('image');
const ph = document.getElementById('ph');

const applyWrap = document.getElementById('applyWrap');
const applyBtn = document.getElementById('applyBtn');
const cancelBtn = document.getElementById('cancelBtn');
const toolWrap = document.getElementById('toolWrap');
const editBtn = document.getElementById('editBtn');
const fillBtn = document.getElementById('fillBtn');
const resetBtn = document.getElementById('resetBtn');
const downloadBtn = document.getElementById('downloadBtn');
const zoomWrap = document.getElementById('zoomWrap');
const zoomRange = document.getElementById('zoomRange');
const rotLBtn = document.getElementById('rotLBtn');
const rotRBtn = document.getElementById('rotRBtn');

let isEditMode = false;
let isFillMode = false;
let lastCommittedDataUrl = "";

const vidBtn = document.getElementById('vidBtn');
const vidInput = document.getElementById('vidInput'); // kept, but unused now

/* === Report export (Confirm -> report.html) === */
let lastImageDataUrl = '';
let lastVideoName = '';
let lastVideoUrl = '';
let qrImageDataUrl = '';
let qrSvgText = '';
let isQrPick = false;

const qrBtn = document.getElementById('qrBtn');

/* === QR Side Button (Gallery -> Fullscreen) === */
let qrSelectedDataUrl = '';

function updateQrSidePreview(dataUrl){
  const sideBtn = document.getElementById('qrSideBtn');
  const sideImg = document.getElementById('qrSideBtnImg');
  const modal = document.getElementById('qrModal');
  const modalImg = document.getElementById('qrModalImg');

  qrSelectedDataUrl = dataUrl || '';

  if(sideImg){
    sideImg.removeAttribute('src');
    sideImg.style.display = 'none';
  }
  if(sideBtn){
    sideBtn.classList.toggle('has-qr', !!qrSelectedDataUrl);
  }
  if(modalImg && qrSelectedDataUrl) modalImg.src = qrSelectedDataUrl;
  if(modal) modal.style.display = 'none';
}

function openQrPicker(){
  if(qrInput){
    qrInput.value = '';
    qrInput.click();
  }
}

(function(){
  const qrSideBtn = document.getElementById('qrSideBtn');
  const qrSideChange = document.getElementById('qrSideChange');
  const modal = document.getElementById('qrModal');
  const modalImg = document.getElementById('qrModalImg');

  if(!qrSideBtn || !modal || !modalImg) return;

  qrSideBtn.addEventListener('click', (e) => {
    if(e.target && (e.target.id === 'qrSideChange')) return;
    if(!qrSelectedDataUrl){
      openQrPicker();
      return;
    }
    modalImg.src = qrSelectedDataUrl;
    modal.style.display = 'flex';
  });

  if(qrSideChange){
    qrSideChange.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openQrPicker();
    });
  }

  let lpTimer = null;
  let moved = false;
  let sx = 0, sy = 0;
  const LP = 500;
  const TOL = 10;

  function clearLP(){ if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; } }

  qrSideBtn.addEventListener('pointerdown', (e) => {
    moved = false;
    sx = e.clientX; sy = e.clientY;
    clearLP();
    lpTimer = setTimeout(() => { if(!moved){ openQrPicker(); } }, LP);
  });

  qrSideBtn.addEventListener('pointermove', (e) => {
    if(!lpTimer) return;
    if(Math.abs(e.clientX - sx) > TOL || Math.abs(e.clientY - sy) > TOL){
      moved = true;
      clearLP();
    }
  });

  qrSideBtn.addEventListener('pointerup', clearLP);
  qrSideBtn.addEventListener('pointercancel', clearLP);

  modal.addEventListener('click', () => { modal.style.display = 'none'; });
})();

/* Capture image as DataURL for transfer to report.html */
function captureImageDataUrl(file){
  try{
    const reader = new FileReader();
    reader.onload = () => { lastImageDataUrl = reader.result || ''; };
    reader.readAsDataURL(file);
  }catch(e){}
}

const video = document.getElementById('video');
let cropper = null;

/* === Pan after Apply === */
let panEnabled = false;
let isPanning = false;
let startX = 0, startY = 0;
let curX = 0, curY = 0;

function smartFitBox(){
  if(!image || !image.src) return;
  if(!image.naturalWidth || !image.naturalHeight) return;
  const boxWidth = imageBox.clientWidth;
  const ratio = image.naturalHeight / image.naturalWidth;
  const newH = Math.max(180, Math.min(520, boxWidth * ratio));
  imageBox.style.height = newH + 'px';
}
window.addEventListener('resize', smartFitBox);

function showTools(){
  if(!image.src) return;
  if(video && video.style.display === 'block') return;
  toolWrap.style.display = 'flex';
}
function hideTools(){
  toolWrap.style.display = 'none';
  if(!isEditMode) zoomWrap.style.display = 'none';
}
function toggleTools(){
  if(toolWrap.style.display === 'none' || !toolWrap.style.display) showTools();
  else hideTools();
}

function setImageTransform(){ image.style.transform = `translate(${curX}px, ${curY}px)`; }

function enablePan(){
  panEnabled = true;
  image.style.cursor = 'grab';
}
function disablePan(){
  panEnabled = false;
  isPanning = false;
  curX = 0; curY = 0;
  image.style.transform = '';
  image.style.cursor = 'default';
}

function downloadCurrentImage(){
  if(!image.src) return;
  const a = document.createElement('a');
  const name = `image_${Date.now()}.jpg`;
  if(image.src.startsWith('data:')){
    a.href = image.src; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    return;
  }
  fetch(image.src).then(r => r.blob()).then(blob => {
    const url = URL.createObjectURL(blob);
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }).catch(()=>{});
}

function enterEditMode(){
  if(!image.src || isEditMode) return;
  disablePan();
  isEditMode = true;
  zoomWrap.style.display = 'flex';
  editBtn.classList.add('on');
  if(cropper) cropper.destroy();
  cropper = new Cropper(image, {
    viewMode: 1,
    dragMode: 'move',
    aspectRatio: NaN,
    autoCropArea: 1,
    responsive: true,
    background: false,
    movable: true,
    zoomable: true,
    rotatable: true,
    scalable: true
  });
  zoomRange.value = 1;
}

function exitEditMode(commit){
  if(!isEditMode) return;
  isEditMode = false;
  editBtn.classList.remove('on');
  zoomWrap.style.display = 'none';

  if(!cropper) return;

  if(commit){
    const canvas = cropper.getCroppedCanvas({
      fillColor: '#ffffff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high'
    });
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    image.src = dataUrl;
    lastCommittedDataUrl = dataUrl;
    image.onload = () => { smartFitBox(); image.onload = null; };
  }else{
    if(lastCommittedDataUrl){
      image.src = lastCommittedDataUrl;
      image.onload = () => { smartFitBox(); image.onload = null; };
    }
  }
  cropper.destroy(); cropper = null;
  if(isFillMode) enablePan();
}

function pointerDown(e){
  if(!panEnabled) return;
  isPanning = true;
  image.setPointerCapture?.(e.pointerId);
  image.style.cursor = 'grabbing';
  startX = e.clientX - curX;
  startY = e.clientY - curY;
}
function pointerMove(e){
  if(!panEnabled || !isPanning) return;
  curX = e.clientX - startX;
  curY = e.clientY - startY;
  setImageTransform();
}
function pointerUp(){
  if(!panEnabled) return;
  isPanning = false;
  image.style.cursor = 'grab';
}

image.addEventListener('pointerdown', pointerDown);
image.addEventListener('pointermove', pointerMove);
image.addEventListener('pointerup', pointerUp);
image.addEventListener('pointercancel', pointerUp);
image.addEventListener('pointerleave', pointerUp);

/* Long press image box to toggle tools */
let lpTimer = null;
let lpStartX = 0, lpStartY = 0;
let lpMoved = false;
const LONG_PRESS_MS = 550;
const MOVE_TOLERANCE = 10;

function clearLongPress(){ if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; } }

function onLPDown(e){
  if(!image.src) return;
  if(isEditMode) return;
  if(applyWrap.style.display === 'flex') return;
  lpMoved = false;
  lpStartX = e.clientX ?? (e.touches?.[0]?.clientX ?? 0);
  lpStartY = e.clientY ?? (e.touches?.[0]?.clientY ?? 0);
  clearLongPress();
  lpTimer = setTimeout(() => { if(!lpMoved){ toggleTools(); } }, LONG_PRESS_MS);
}
function onLPMove(e){
  if(!lpTimer) return;
  const x = e.clientX ?? (e.touches?.[0]?.clientX ?? 0);
  const y = e.clientY ?? (e.touches?.[0]?.clientY ?? 0);
  if(Math.abs(x - lpStartX) > MOVE_TOLERANCE || Math.abs(y - lpStartY) > MOVE_TOLERANCE){
    lpMoved = true;
    clearLongPress();
  }
}
function onLPUp(){ clearLongPress(); }

imageBox.addEventListener('pointerdown', onLPDown);
imageBox.addEventListener('pointermove', onLPMove);
imageBox.addEventListener('pointerup', onLPUp);
imageBox.addEventListener('pointercancel', onLPUp);
imageBox.addEventListener('touchstart', onLPDown, {passive:true});
imageBox.addEventListener('touchmove', onLPMove, {passive:true});
imageBox.addEventListener('touchend', onLPUp);

let toolsTapTimer = null;
imageBox.addEventListener('click', () => {
  if(!image.src) return;
  if(video && video.style.display === 'block') return;
  showTools();
  if(toolsTapTimer) clearTimeout(toolsTapTimer);
  toolsTapTimer = setTimeout(() => {
    if(isEditMode || isFillMode) return;
    hideTools();
  }, 500);
});

/* Upload image (IMAGE button only) */
imgBtn.onclick = () => { imgInput.value = ''; imgInput.click(); };

imgInput.onchange = (e) => {
  const file = e.target.files?.[0];
  if(!file) return;

  captureImageDataUrl(file);
  isQrPick = false;

  disablePan();
  isFillMode = false;
  fillBtn.classList.remove('on');
  fillBtn.setAttribute('aria-pressed','false');
  if(isEditMode){ isEditMode = false; }
  if(cropper){ cropper.destroy(); cropper = null; }
  zoomWrap.style.display = 'none';
  editBtn.classList.remove('on');

  const url = URL.createObjectURL(file);
  imageBox.style.height = '240px';
  image.onload = () => {
    image.onload = null;
    smartFitBox();
    if(cropper) cropper.destroy();
    cropper = new Cropper(image, {
      viewMode: 1,
      dragMode: 'move',
      aspectRatio: NaN,
      autoCropArea: 0.92,
      responsive: true,
      background: false,
      movable: true,
      zoomable: true,
      rotatable: true,
      scalable: true
    });
    applyWrap.style.display = 'flex';
  };

  // ensure video hidden
  video.pause?.();
  video.removeAttribute('src');
  video.load?.();
  video.style.display = 'none';

  image.src = url;
  image.style.display = 'block';
  ph.style.display = 'none';
  toolWrap.style.display = 'flex';
  lastCommittedDataUrl = image.src;
};

if(qrInput){
  qrBtn.onclick = () => { qrInput.value = ''; qrInput.click(); };

  qrInput.onchange = (e) => {
    const file = e.target.files?.[0];
    if(!file) return;

    const badge = document.getElementById('qrBadge');
    qrSvgText = '';
    if(badge){ badge.style.display = 'none'; badge.innerHTML = ''; }

    const isSvg = (file.type === 'image/svg+xml') || (file.name || '').toLowerCase().endsWith('.svg');

    try{
      const reader = new FileReader();
      reader.onload = () => {
        if(isSvg){
          let svgText = String(reader.result || '');
          svgText = svgText.replace(/<script[\s\S]*?<\/script>/gi, '');
          qrSvgText = svgText;

          const svgDataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(qrSvgText);
          qrImageDataUrl = svgDataUrl;
          updateQrSidePreview(qrImageDataUrl);

          const modal = document.getElementById('qrModal');
          if(modal) modal.style.display = 'flex';
          return;
        }

        qrImageDataUrl = reader.result || '';
        updateQrSidePreview(qrImageDataUrl);

        const modal = document.getElementById('qrModal');
        if(modal) modal.style.display = 'flex';
      };

      if(isSvg) reader.readAsText(file);
      else reader.readAsDataURL(file);
    }catch(err){}
  };
}

/* Apply / Cancel */
applyBtn.onclick = () => {
  if(isEditMode){ exitEditMode(true); }
  image.style.pointerEvents = 'auto';
  image.style.userSelect = 'none';
  curX = 0; curY = 0;
  image.style.transform = 'translate(0,0)';
  applyWrap.style.display = 'none';
  lastCommittedDataUrl = image.src;
  hideTools();

  if(isFillMode){
    image.style.objectFit = 'cover';
    enablePan();
  }else{
    image.style.objectFit = 'contain';
    disablePan();
  }
};

cancelBtn.onclick = () => {
  if(isEditMode){ exitEditMode(false); return; }
  if(cropper){ cropper.destroy(); cropper = null; }
  disablePan();
  isFillMode = false;
  fillBtn.classList.remove('on');
  fillBtn.setAttribute('aria-pressed','false');
  applyWrap.style.display = 'none';
  toolWrap.style.display = 'none';
  lastCommittedDataUrl = image.src;
};

/* Tools */
editBtn.onclick = () => {
  if(!image.src) return;
  if(isEditMode) exitEditMode(false);
  else { applyWrap.style.display = 'flex'; enterEditMode(); }
};

fillBtn.onclick = () => {
  if(!image.src) return;
  isFillMode = !isFillMode;
  fillBtn.classList.toggle('on', isFillMode);
  fillBtn.setAttribute('aria-pressed', isFillMode ? 'true':'false');
  if(isEditMode) return;
  if(isFillMode){ image.style.objectFit = 'cover'; enablePan(); }
  else { image.style.objectFit = 'contain'; disablePan(); image.style.transform='translate(0,0)'; curX=0; curY=0; }
};

resetBtn.onclick = () => {
  if(!image.src) return;
  if(isEditMode && cropper){ cropper.reset(); zoomRange.value = 1; return; }
  disablePan();
  isFillMode = false;
  fillBtn.classList.remove('on');
  fillBtn.setAttribute('aria-pressed','false');
  image.style.objectFit = 'contain';
  image.style.transform = 'translate(0,0)';
  curX = 0; curY = 0;
  smartFitBox();
};

downloadBtn.onclick = () => downloadCurrentImage();

zoomRange.addEventListener('input', () => {
  const z = parseFloat(zoomRange.value);
  if(cropper) cropper.zoomTo(z);
});
rotLBtn.onclick = () => { if(cropper) cropper.rotate(-90); };
rotRBtn.onclick = () => { if(cropper) cropper.rotate(90); };

/* =========================
   ✅ VIDEO: LINK ONLY (NO UPLOAD)
   - FUNCTION button just focuses the video link input
   - No file picker, no supabase, no local video preview
========================= */
(function(){
  // make sure local video is always hidden
  lastVideoName = '';
  lastVideoUrl = '';
  if(video){
    video.pause?.();
    video.removeAttribute('src');
    video.load?.();
    video.style.display = 'none';
  }

  // disable any old file picker usage
  if(vidInput){
    vidInput.value = '';
    vidInput.onchange = null;
  }

  vidBtn.onclick = () => {
    const linkEl = document.getElementById('videoLink');
    if(!linkEl) return;
    linkEl.focus();
    linkEl.scrollIntoView({behavior:'smooth', block:'center'});
  };
})();

/* === CONFIRM: go to report.html with sessionStorage data === */
(function () {
  const confirmBtn = document.getElementById('confirmBtn');
  if (!confirmBtn) return;

  confirmBtn.addEventListener('click', function () {
    const data = collectFormData();
    sessionStorage.setItem('assem_report_data', JSON.stringify(data));
    window.location.href = 'report.html';
  });

  function collectFormData(){
    const getVal = (id) => (document.getElementById(id)?.value || '');
    const vlink = (document.getElementById('videoLink')?.value || '').trim();

    return {
      customer: getVal('customer'),
      rig: getVal('rig'),
      system: getVal('system'),
      deviceId: getVal('deviceId'),
      loadcellNum: getVal('loadcellNum'),
      loadcellType: getVal('loadcellType'),
      deviceStatus: getVal('deviceStatus'),
      threadType: getVal('threadType'),
      threadSize: getVal('threadSize'),
      tech1: getVal('tech1'),
      tech2: getVal('tech2'),
      imageDataUrl: lastImageDataUrl || '',
      qrImageDataUrl: (typeof qrSelectedDataUrl !== 'undefined' ? (qrSelectedDataUrl || '') : (qrImageDataUrl || '')),
      videoName: '',            // ✅ no upload
      videoUrl: vlink || ''     // ✅ link only
    };
  }
})();
</script>

<!-- =========================================================
     ✅ Supabase code موجود لكنه "مقفول" (لن يعمل ولن يسبب أخطاء)
     (مش هنحذفه عشان انت قلت مش هتحذف حاجة)
========================================================= -->

<!--
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = "https://oescgxsgmfpixkfrsmju.supabase.co";
  const SUPABASE_KEY = "sb_publishable_BwCexQ9vm4kEX4RmBvqvLQ_0F8KMIqJ";
  const SUPABASE_BUCKET = "uploads";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  console.log("Supabase ready:", !!supabaseClient);
</script>

<script>
async function uploadVideoToSupabase(file){
  if(!window.supabase || !window.supabase.createClient){
    throw new Error("Supabase library not loaded");
  }
  if(typeof supabaseClient === "undefined"){
    throw new Error("supabaseClient not defined");
  }
  const ext = (file.name.split('.').pop() || 'mp4').toLowerCase();
  const filePath = `videos/${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;
  const { error } = await supabaseClient.storage.from("uploads").upload(filePath, file, {
    cacheControl: "3600",
    upsert: false,
    contentType: file.type || "video/mp4"
  });
  if(error) throw error;
  const { data } = supabaseClient.storage.from("uploads").getPublicUrl(filePath);
  return data.publicUrl;
}
</script>
-->

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxK9K4ZEmasLuDGu2_oXTqKxZc1102qJxEo8WR2Asib4R7OyWvlf7l-X_bJ7e8spHwB/exec";

async function submitReport(data){
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  });
  const json = await res.json();

  if(json.ok){
    const reportUrl = `report.html?id=${json.id}`;
    generateQR(reportUrl);
    alert("تم حفظ التقرير بنجاح");
  }else{
    alert("حصل خطأ");
  }
}

function generateQR(url){
  const qrImg = document.getElementById("qrImg");
  qrImg.src =
    "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="
    + encodeURIComponent(url);
}
</script>
</body>
</html>
