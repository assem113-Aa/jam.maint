<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ELECTRIC.ASSEM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body{margin:0;min-height:100vh;display:grid;place-items:center;font-family:Arial,sans-serif;background:linear-gradient(180deg,#e8f2ff,#f7fbff)}
.card{width:720px;max-width:96%;background:#fff;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.12);overflow:hidden}
.header{text-align:center;padding:18px}
h1{margin:0;color:#123a62}
.content{padding:16px 18px 20px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{border:1px solid #cfdceb;border-radius:14px;padding:10px 12px;background:#fbfdff}
.field .k{font-size:11px;font-weight:900;color:#2b4a66}
.field .v{margin-top:6px;font-size:14px;font-weight:800;color:#0b1b2b}
.media-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.imgBox{border:2px dashed #cfdceb;border-radius:16px;overflow:hidden;background:#fff;min-height:220px;display:flex;align-items:center;justify-content:center;position:relative}
.imgBox img, .imgBox video{width:100%;height:100%;object-fit:contain;display:none}
.ph{color:#2b4a66;font-weight:900;text-align:center;padding:14px}
.fault{margin-top:14px}
label{display:block;font-size:12px;font-weight:900;color:#2b4a66;margin-bottom:6px}
textarea{width:100%;min-height:120px;resize:vertical;padding:12px;border-radius:14px;border:1px solid #cfdceb;font-weight:700}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.tool{padding:10px 12px;border-radius:14px;border:1px solid #cfdceb;background:#eef6ff;color:#0b4c86;font-weight:900;cursor:pointer;display:flex;align-items:center;gap:8px}
.send{background:#1faa59;color:#fff;border:none}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:50;align-items:center;justify-content:center;padding:18px;cursor:pointer}
#modal img,#modal video{width:100vw;height:100vh;object-fit:contain;background:#fff}
</style>
</head>

<body>
<div class="card">
  <div class="header">
    <h1>ELECTRIC.ASSEM</h1>
  </div>

  <div class="content">
    <div class="grid" id="fields"></div>

    <div class="media-wrap">
      <!-- IMAGE -->
      <div class="imgBox">
        <img id="mainImg" alt="Report Image">
        <div class="ph" id="imgPh"><i class="fa-solid fa-image"></i> IMAGE</div>
      </div>

      <!-- VIDEO -->
      <div class="imgBox">
        <video id="vid" controls playsinline preload="metadata"></video>
        <div class="ph" id="vidPh"><i class="fa-solid fa-video"></i> VIDEO</div>
      </div>
    </div>

    <div class="fault">
      <label>FAULT DESCRIPTION</label>
      <textarea id="fault" placeholder="Write fault description here..."></textarea>

      <div class="row">
        <button class="tool" id="mediaBtn"><i class="fa-solid fa-upload"></i> Upload Photo/Video</button>
        <button class="tool send" id="sendBtn"><i class="fa-brands fa-whatsapp"></i> SEND</button>
      </div>
    </div>
  </div>
</div>

<div id="modal">
  <img id="modalImg" style="display:none">
  <video id="modalVid" controls style="display:none"></video>
</div>

<!-- hidden picker -->
<input id="mediaInput" type="file" accept="image/*,video/*" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0" />

<script>
/* ✅ WhatsApp number: 01274693883 => international */
const WHATSAPP_NUMBER = "201274693883";

/* ✅ Google Apps Script Web App */
const API_URL = "https://script.google.com/macros/s/AKfycbxK9K4ZEmasLuDGu2_oXTqKxZc1102qJxEo8WR2Asib4R7OyWvlf7l-X_bJ7e8spHwB/exec";

/* Fields to render */
const fields = [
 ["CUSTOMER","customer"],["RIG","rig"],["SYSTEM","system"],["DEVICE ID","deviceId"],
 ["THREAD TYPE","threadType"],["SIZE","threadSize"],
 ["JAM TECH 1","tech1"],["JAM TECH 2","tech2"],
 ["LOADCELL S/N","loadcellNum"],["LOADCELL TYPE","loadcellType"],
 ["DEVICE STATUS","deviceStatus"]
];

const fieldsEl = document.getElementById('fields');

const mainImg = document.getElementById('mainImg');
const imgPh = document.getElementById('imgPh');
const vid = document.getElementById('vid');
const vidPh = document.getElementById('vidPh');

function clearFields(){
  fieldsEl.innerHTML = "";
}

function renderFields(data){
  clearFields();
  fields.forEach(([k,v])=>{
    const d=document.createElement('div');
    d.className='field';
    d.innerHTML=`<div class="k">${k}</div><div class="v">${(data?.[v] || "-")}</div>`;
    fieldsEl.appendChild(d);
  });
}

function showImg(el, phEl, src){
  if(!src){ el.style.display='none'; phEl.style.display='block'; return; }
  el.src = src;
  el.style.display = 'block';
  phEl.style.display = 'none';
}
function showVid(el, phEl, src){
  if(!src){ el.style.display='none'; phEl.style.display='block'; return; }
  el.src = src;
  el.style.display = 'block';
  phEl.style.display = 'none';
}

/* fullscreen modal */
function openImg(src){
  const m=document.getElementById('modal');
  const mi=document.getElementById('modalImg');
  const mv=document.getElementById('modalVid');
  mv.pause?.();
  mv.removeAttribute('src');
  mv.style.display='none';
  mi.src=src;
  mi.style.display='block';
  m.style.display='flex';
}
function openVid(src){
  const m=document.getElementById('modal');
  const mi=document.getElementById('modalImg');
  const mv=document.getElementById('modalVid');
  mi.removeAttribute('src');
  mi.style.display='none';
  mv.src=src;
  mv.style.display='block';
  m.style.display='flex';
}
document.getElementById('modal').onclick=()=>{
  const m=document.getElementById('modal');
  const mi=document.getElementById('modalImg');
  const mv=document.getElementById('modalVid');
  m.style.display='none';
  mi.style.display='none';
  mv.style.display='none';
  mv.pause?.();
};

mainImg.addEventListener('click', ()=> mainImg.src && openImg(mainImg.src));
vid.addEventListener('click', ()=> vid.src && openVid(vid.src));

/* Upload button (optional - changes preview only, not saved to sheets) */
const mediaBtn = document.getElementById('mediaBtn');
const mediaInput = document.getElementById('mediaInput');
mediaBtn.onclick = () => { mediaInput.value=''; mediaInput.click(); };

mediaInput.onchange = (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);

  if(file.type.startsWith('image/')){
    showImg(mainImg, imgPh, url);
  }else if(file.type.startsWith('video/')){
    showVid(vid, vidPh, url);
  }
};

/* SEND WhatsApp */
document.getElementById('sendBtn').onclick=()=>{
  const fault=document.getElementById('fault').value||"-";
  const data = window.__REPORT_DATA__ || JSON.parse(sessionStorage.getItem('assem_report_data') || "{}");

  let msg="ELECTRIC.ASSEM REPORT\n";
  fields.forEach(([k,v])=>msg+=`${k}: ${data?.[v] || "-"}\n`);
  msg+="FAULT DESCRIPTION:\n"+fault;

  window.open("https://wa.me/"+WHATSAPP_NUMBER+"?text="+encodeURIComponent(msg));
};

/* ========= Load logic =========
   1) if URL has ?id= -> fetch from Apps Script and render (fixed data)
   2) else -> render from sessionStorage (coming directly from index confirm)
*/
(async function init(){
  const params = new URLSearchParams(window.location.search);
  const id = (params.get("id") || "").trim();

  if(id){
    try{
      const res = await fetch(API_URL + "?id=" + encodeURIComponent(id));
      const json = await res.json();

      if(!json.ok){
        alert("التقرير غير موجود");
        return;
      }

      // ✅ keep a copy for WhatsApp / fallback
      window.__REPORT_DATA__ = json.data;
      sessionStorage.setItem("assem_report_data", JSON.stringify(json.data));

      renderFields(json.data);
      showImg(mainImg, imgPh, json.data.imageDataUrl || "");
      showVid(vid, vidPh, json.data.videoUrl || "");

      return;
    }catch(err){
      alert("حصل خطأ في تحميل التقرير");
      return;
    }
  }

  // no id => try sessionStorage
  const data = JSON.parse(sessionStorage.getItem('assem_report_data') || "{}");
  if(!Object.keys(data).length){
    alert("لا يوجد بيانات تقرير (افتحه من QR أو من index)");
    return;
  }

  window.__REPORT_DATA__ = data;
  renderFields(data);
  showImg(mainImg, imgPh, data.imageDataUrl || "");
  showVid(vid, vidPh, data.videoUrl || "");
})();
</script>

</body>
</html>
